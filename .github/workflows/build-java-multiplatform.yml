name: Build Java Multi-Platform

on:
  workflow_dispatch:
  push:
    branches: ["main", "main-dev"]
    paths:
      - "java/**"
      - "include/**"
      - "build.gradle"
      - ".github/workflows/build-java-multiplatform.yml"

env:
  JAVA_VERSION: 21

jobs:
  build_jni_macos:
    name: Build JNI for macOS
    runs-on: macos-15
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: amd64
            cmake_arch: x86_64
          - arch: arm64
            cmake_arch: arm64

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Pull Git submodules
        run: git submodule update --init --recursive

      - name: Set up Java
        uses: actions/setup-java@v5
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: "adopt"

      - name: Build JNI library
        run: |
          cmake -B build_artifacts \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_OSX_ARCHITECTURES=${{ matrix.cmake_arch }} \
            -DUSEARCH_BUILD_JNI=1 \
            -DUSEARCH_BUILD_TEST_CPP=0 \
            -DUSEARCH_BUILD_BENCH_CPP=0 \
            -DUSEARCH_BUILD_LIB_C=0 \
            -DUSEARCH_USE_FP16LIB=1 \
            -DUSEARCH_USE_SIMSIMD=1 \
            -DSIMSIMD_TARGET_HASWELL=1 \
            -DSIMSIMD_TARGET_NEON=1 \
            -DSIMSIMD_TARGET_NEON_BF16=1 \
            -DSIMSIMD_TARGET_NEON_F16=1 \
            -DSIMSIMD_TARGET_NEON_I8=1 \
            -DSIMSIMD_DYNAMIC_DISPATCH=1

          cmake --build build_artifacts --config Release

      - name: Upload JNI library artifact
        uses: actions/upload-artifact@v4
        with:
          name: usearch-jni-macos-${{ matrix.arch }}
          path: build_artifacts/libusearch_jni.dylib
          retention-days: 7

  build_jni_linux:
    name: Build JNI for Linux
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: amd64
            target: x86_64-linux-gnu
          - arch: arm64
            target: aarch64-linux-gnu

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Pull Git submodules
        run: git submodule update --init --recursive

      - name: Set up Java
        uses: actions/setup-java@v5
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: "adopt"

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y clang lld make crossbuild-essential-arm64

      - name: Build JNI library
        run: |
          cmake -B build_artifacts \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_C_COMPILER_TARGET=${{ matrix.target }} \
            -DCMAKE_CXX_COMPILER_TARGET=${{ matrix.target }} \
            -DCMAKE_SYSTEM_NAME=Linux \
            -DCMAKE_SYSTEM_PROCESSOR=${{ matrix.arch }} \
            -DUSEARCH_BUILD_JNI=1 \
            -DUSEARCH_BUILD_TEST_CPP=0 \
            -DUSEARCH_BUILD_BENCH_CPP=0 \
            -DUSEARCH_BUILD_LIB_C=0 \
            -DUSEARCH_USE_FP16LIB=1 \
            -DUSEARCH_USE_SIMSIMD=1 \
            -DSIMSIMD_TARGET_HASWELL=1 \
            -DSIMSIMD_TARGET_SKYLAKE=1 \
            -DSIMSIMD_TARGET_ICE=1 \
            -DSIMSIMD_TARGET_GENOA=1 \
            -DSIMSIMD_TARGET_SAPPHIRE=1 \
            -DSIMSIMD_TARGET_NEON=1 \
            -DSIMSIMD_TARGET_NEON_BF16=1 \
            -DSIMSIMD_TARGET_NEON_F16=1 \
            -DSIMSIMD_TARGET_NEON_I8=1 \
            -DSIMSIMD_TARGET_SVE=1 \
            -DSIMSIMD_TARGET_SVE_BF16=1 \
            -DSIMSIMD_TARGET_SVE_F16=1 \
            -DSIMSIMD_TARGET_SVE_I8=1 \
            -DSIMSIMD_TARGET_SVE2=1 \
            -DSIMSIMD_DYNAMIC_DISPATCH=1

          cmake --build build_artifacts --config Release -j

      - name: Upload JNI library artifact
        uses: actions/upload-artifact@v4
        with:
          name: usearch-jni-linux-${{ matrix.arch }}
          path: build_artifacts/libusearch_jni.so
          retention-days: 7

  build_fat_jar:
    name: Build Fat JAR
    needs: [build_jni_macos, build_jni_linux]
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Pull Git submodules
        run: git submodule update --init --recursive

      - name: Download all JNI libraries
        uses: actions/download-artifact@v4
        with:
          pattern: usearch-jni-*

      - name: Set up Java
        uses: actions/setup-java@v5
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: "adopt"

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5

      - name: Organize JNI libraries
        run: |
          mkdir -p build/libs/usearch/shared/{linux-amd64,linux-arm64,darwin-amd64,darwin-arm64}

          # Linux
          cp usearch-jni-linux-amd64/libusearch_jni.so build/libs/usearch/shared/linux-amd64/ || true
          cp usearch-jni-linux-arm64/libusearch_jni.so build/libs/usearch/shared/linux-arm64/ || true

          # macOS
          cp usearch-jni-macos-amd64/libusearch_jni.dylib build/libs/usearch/shared/darwin-amd64/ || true
          cp usearch-jni-macos-arm64/libusearch_jni.dylib build/libs/usearch/shared/darwin-arm64/ || true

          echo "=== JNI libraries organized ==="
          find build/libs/usearch/shared -name "libusearch_jni.*" | sort

      - name: Build fat JAR
        run: |
          gradle compileJava processResources
          gradle fatJar

      - name: Verify fat JAR contents
        run: |
          VERSION=$(cat VERSION)
          echo "=== Verifying fat JAR contents ==="
          jar tf build/libs/usearch-*.jar | grep -E "usearch-native.*\.(so|dll|dylib)" | sort

          lib_count=$(jar tf build/libs/usearch-*.jar | grep -E "usearch-native.*\.(so|dll|dylib)" | wc -l)
          echo "Found $lib_count native libraries in fat JAR"

      - name: Upload fat JAR
        uses: actions/upload-artifact@v4
        with:
          name: usearch-fat-jar
          path: build/libs/usearch-*.jar
          retention-days: 7

      - name: Run tests
        run: gradle test
